<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kabo Focus</title>
    <style>
        :root {
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --subtext: #8E8E93;
            --blue: #007AFF;
            --green: #34C759;
            --red: #FF3B30;
            --input-bg: #F2F2F7;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card: #1C1C1E;
                --text: #FFFFFF;
                --subtext: #98989F;
                --input-bg: #2C2C2E;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3 { text-align: center; margin: 10px 0; }
        
        .setup-container {
            max-width: 500px;
            margin: 30px auto;
            text-align: center;
        }
        
        input[type="text"], input[type="tel"] {
            width: 70%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: var(--card);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 15px;
        }

        .btn {
            background: var(--blue);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:disabled { opacity: 0.5; }
        .btn-secondary { background: var(--subtext); }
        .btn-outline { background: transparent; color: var(--red); border: 1px solid var(--red); }

        .chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .chip {
            background: var(--card);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .top-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .top-controls .btn {
            padding: 8px;
            font-size: 14px;
            margin-bottom: 0;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .header-info h2 {
            margin: 0;
            font-size: 20px;
        }

        .round-badge {
            background: var(--subtext);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
        }

        .player-card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 14px;
            color: var(--subtext);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-score {
            font-size: 30px;
            font-weight: 800;
            margin-top: 2px;
            font-variant-numeric: tabular-nums;
        }

        .round-input-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        .round-input {
            width: 65px;
            height: 42px;
            background: var(--input-bg);
            border: none;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            color: var(--text);
            font-weight: 600;
            padding: 0;
            margin: 0;
        }

        .round-input:focus {
            outline: 2px solid var(--blue);
            background: var(--card);
        }

        .input-label {
            font-size: 11px;
            color: var(--subtext);
        }

        .action-bar {
            position: fixed;
            bottom: 15px;
            left: 15px;
            right: 15px;
            z-index: 100;
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-content {
            background: var(--bg);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: var(--card);
            border-radius: 8px;
            overflow: hidden;
        }

        .history-table th, .history-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--input-bg);
            font-size: 16px;
        }
        
        .history-table th {
            background: var(--blue);
            color: white;
            font-size: 14px;
        }

        .edit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .clickable-link {
            color: var(--blue);
            cursor: pointer;
            font-weight: 600;
        }

        .clickable-link:hover {
            text-decoration: underline;
        }

        .winner-crown { color: #FFD700; margin-right: 5px; }
        
        .hidden { display: none !important; }
        .lowest-score { color: var(--green); }
        .high-score { color: var(--red); }

    </style>
</head>
<body>

    <div id="setupView" class="setup-container">
        <h1>Kabo Tracker</h1>
        <p style="color:var(--subtext); font-size: 14px; margin-top: -5px;">Add 4+ players</p>
        
        <input type="text" id="newPlayerName" placeholder="Player Name" autocomplete="off">
        <button class="btn" onclick="addPlayer()">Add</button>
        
        <div class="chip-container" id="playerChips"></div>
        
        <button id="startBtn" class="btn" onclick="startGame()" disabled style="background: var(--green);">Start Game</button>
        
        <div style="margin-top: 25px; border-top: 1px solid var(--subtext); padding-top: 15px;" id="pastGamesSection" class="hidden">
            <h3>Saved Games & Leaderboard</h3>
            <button class="btn btn-secondary" onclick="openLeaderboard()" style="margin-bottom: 15px;">View Leaderboard</button>
            
            <div id="pastGamesList" style="text-align: left; margin-bottom: 20px;"></div>

            <button class="btn btn-outline" onclick="clearPastGames()">Clear History</button>
        </div>
    </div>

    <div id="gameView" class="hidden">
        <div class="top-controls">
            <button class="btn btn-secondary" onclick="openHistory()">Game Scores</button>
            <button id="editRoundBtn" class="btn btn-secondary hidden" onclick="openEditModal()">Edit Last Round</button>
        </div>

        <div class="header-info">
            <h2 id="roundDisplay">Round 1</h2>
            <div class="round-badge" id="roundBadge" onclick="goHome()" style="cursor: pointer;">1 / 13</div>
        </div>

        <div id="cardsContainer"></div>

        <div class="action-bar">
            <button id="nextRoundBtn" class="btn" onclick="finishRound()">Finish Round 1</button>
            <button id="resetBtn" class="btn hidden" onclick="startNewGame()" style="background: var(--blue);">Start New Game</button>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Current Scores</h2>
            <div id="historyTableContainer"></div>
            <button class="btn" onclick="closeModal('historyModal')" style="margin-top: 15px;">Close</button>
        </div>
    </div>

    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Edit Round <span id="editRoundNumber"></span></h2>
            <div id="editInputsContainer"></div>
            <button class="btn" onclick="saveEditedRound()" style="margin-top: 15px; background: var(--green);">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
        </div>
    </div>

    <div id="leaderboardModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>All-Time Leaderboard</h2>
            <p style="font-size: 12px; color: var(--subtext); text-align: center;">Click a player's name to see their wins.</p>
            <div id="leaderboardContainer"></div>
            <button class="btn" onclick="closeModal('leaderboardModal')" style="margin-top: 15px;">Close</button>
        </div>
    </div>

    <div id="playerWinsModal" class="modal-overlay hidden" style="z-index: 210;">
        <div class="modal-content">
            <h2 id="playerWinsTitle">Player Wins</h2>
            <div id="playerWinsContainer"></div>
            <button class="btn" onclick="closeModal('playerWinsModal')" style="margin-top: 15px;">Back</button>
        </div>
    </div>

    <div id="pastGameDetailsModal" class="modal-overlay hidden" style="z-index: 220;">
        <div class="modal-content">
            <h2 id="pastGameDetailsTitle">Game Details</h2>
            <div id="pastGameDetailsContainer"></div>
            <button class="btn" onclick="closeModal('pastGameDetailsModal')" style="margin-top: 15px;">Close Details</button>
        </div>
    </div>

    <div id="confirmClearModal" class="modal-overlay hidden" style="z-index: 300;">
        <div class="modal-content" style="text-align: center;">
            <h2>Clear History?</h2>
            <p style="color:var(--subtext); margin-bottom: 20px;">Are you sure you want to delete all saved past games? This cannot be undone.</p>
            <button class="btn" onclick="confirmClearPastGames()" style="background: var(--red);">Delete</button>
            <button class="btn btn-secondary" onclick="closeModal('confirmClearModal')">Cancel</button>
        </div>
    </div>

    <div id="confirmNewGameModal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: center;">
            <h2>Start New Game?</h2>
            <p style="color:var(--subtext); margin-bottom: 20px;">Do you want to start a new game with the exact same players?</p>
            <button class="btn" onclick="confirmNewGame()" style="background: var(--green);">Yes, Start</button>
            <button class="btn btn-secondary" onclick="closeModal('confirmNewGameModal')">Cancel</button>
        </div>
    </div>

    <script>
        let players = [];
        let currentRound = 1;
        const TOTAL_ROUNDS = 13;

        // --- Initialization & Storage ---
        window.onload = function() {
            loadGame();
            checkPastGames();
        };

        function saveGame() {
            const state = { players, currentRound };
            localStorage.setItem('kaboCurrentState', JSON.stringify(state));
        }

        function loadGame() {
            const saved = localStorage.getItem('kaboCurrentState');
            if (saved) {
                const state = JSON.parse(saved);
                players = state.players;
                currentRound = state.currentRound;
                document.getElementById('setupView').classList.add('hidden');
                document.getElementById('gameView').classList.remove('hidden');
                renderGame();
            }
        }

        function getFormattedDate() {
            const d = new Date();
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function archiveCurrentGame() {
            let pastGames = JSON.parse(localStorage.getItem('kaboPastGames') || '[]');
            
            pastGames.push({
                date: getFormattedDate(),
                players: JSON.parse(JSON.stringify(players))
            });
            localStorage.setItem('kaboPastGames', JSON.stringify(pastGames));
            localStorage.removeItem('kaboCurrentState');
        }

        function checkPastGames() {
            const pastGames = JSON.parse(localStorage.getItem('kaboPastGames') || '[]');
            if (pastGames.length > 0) {
                document.getElementById('pastGamesSection').classList.remove('hidden');
                renderPastGamesList(pastGames);
            } else {
                document.getElementById('pastGamesSection').classList.add('hidden');
            }
        }

        function renderPastGamesList(pastGames) {
            let html = '';
            for (let i = pastGames.length - 1; i >= 0; i--) {
                const game = pastGames[i];
                const totals = game.players.map(p => p.scores.reduce((a, b) => a + b, 0));
                const minScore = Math.min(...totals);
                const winners = game.players.filter((p, index) => totals[index] === minScore).map(p => p.name).join(' & ');

                html += `
                <div style="background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
                    <div class="clickable-link" onclick="openPastGameDetails(${i})" style="font-size: 15px;">üìÖ ${game.date}</div>
                    <div style="color: var(--subtext); font-size: 13px; margin-top: 4px;">üèÜ Winner: ${winners} (${minScore} pts)</div>
                </div>`;
            }
            document.getElementById('pastGamesList').innerHTML = html;
        }

        function clearPastGames() {
            document.getElementById('confirmClearModal').classList.remove('hidden');
        }

        function confirmClearPastGames() {
            localStorage.removeItem('kaboPastGames');
            checkPastGames();
            closeModal('confirmClearModal');
        }

        // --- Core Logic ---
        function getPlayerTotal(player) {
            return player.scores.reduce((sum, score) => sum + score, 0);
        }

        function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            if(name) {
                players.push({ name: name, scores: [] });
                renderChips();
                input.value = '';
                input.focus();
            }
        }

        function renderChips() {
            const container = document.getElementById('playerChips');
            container.innerHTML = players.map(p => `<div class="chip">${p.name}</div>`).join('');
            
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = players.length < 4;
            startBtn.innerText = players.length < 4 ? `Need ${4 - players.length} more` : "Start Game";
        }

        function startGame() {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('gameView').classList.remove('hidden');
            saveGame();
            renderGame();
        }

        function renderGame() {
            const container = document.getElementById('cardsContainer');
            let newHTML = "";

            const totals = players.map(p => getPlayerTotal(p));
            const minScore = Math.min(...totals);

            players.forEach((player, index) => {
                const currentTotal = totals[index];
                const isWinning = currentTotal === minScore && currentRound > 1;
                const scoreClass = isWinning ? 'lowest-score' : '';
                const crown = isWinning ? '<span class="winner-crown">üëë</span>' : '';

                newHTML += `
                <div class="player-card">
                    <div class="player-info">
                        <div class="player-name">${crown}${player.name}</div>
                        <div class="total-score ${scoreClass}">${currentTotal}</div>
                    </div>
                    <div class="round-input-wrapper">
                        <span class="input-label">Round ${currentRound > TOTAL_ROUNDS ? '-' : currentRound}</span>
                        <input type="tel" class="round-input" id="input-${index}" placeholder="0" pattern="[0-9]*" ${currentRound > TOTAL_ROUNDS ? 'disabled' : ''}>
                    </div>
                </div>`;
            });
            
            container.innerHTML = newHTML;

            // UI Updates
            const isGameOver = currentRound > TOTAL_ROUNDS;
            
            if (isGameOver) {
                const winners = players.filter((p, i) => totals[i] === minScore).map(p => p.name).join(' & ');
                document.getElementById('roundDisplay').innerHTML = `üèÜ ${winners} Wins!`;
                document.getElementById('roundDisplay').style.color = 'var(--green)';
                document.getElementById('roundBadge').innerText = "Done";
            } else {
                document.getElementById('roundDisplay').innerText = "Round " + currentRound;
                document.getElementById('roundDisplay').style.color = 'var(--text)';
                document.getElementById('roundBadge').innerText = `${currentRound} / ${TOTAL_ROUNDS}`;
            }
            
            // Toggle Edit Button
            const editBtn = document.getElementById('editRoundBtn');
            if (currentRound > 1 && !isGameOver) {
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
            }

            const nextBtn = document.getElementById('nextRoundBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            if (isGameOver) {
                nextBtn.classList.add('hidden');
                resetBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                resetBtn.classList.add('hidden');
                nextBtn.innerText = `Finish Round ${currentRound}`;
            }

            saveGame();
        }

        function finishRound() {
            for(let i=0; i<players.length; i++) {
                const input = document.getElementById(`input-${i}`);
                const val = input.value;
                if(val === '') {
                    input.focus(); 
                    return; 
                }
                players[i].scores.push(parseInt(val));
            }

            currentRound++;
            
            if (currentRound > TOTAL_ROUNDS) {
                archiveCurrentGame();
            }

            renderGame();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function startNewGame() {
            document.getElementById('confirmNewGameModal').classList.remove('hidden');
        }

        function confirmNewGame() {
            players.forEach(p => p.scores = []);
            currentRound = 1;
            renderGame();
            closeModal('confirmNewGameModal');
        }

        function goHome() {
            if (currentRound > TOTAL_ROUNDS) {
                document.getElementById('gameView').classList.add('hidden');
                document.getElementById('setupView').classList.remove('hidden');
                
                players = [];
                currentRound = 1;
                renderChips(); 
                localStorage.removeItem('kaboCurrentState'); 
                checkPastGames(); 
            }
        }

        // --- Modals & Features ---
        
        // Detailed Active Game History - Shows all rounds
        function openHistory() {
            const container = document.getElementById('historyTableContainer');
            if (currentRound === 1 && players[0].scores.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>No rounds completed yet.</p>";
            } else {
                let table = '<table class="history-table"><tr><th>R</th>';
                players.forEach(p => table += `<th>${p.name.substring(0,4)}</th>`);
                table += '</tr>';

                for (let r = 0; r < Math.min(currentRound - 1, TOTAL_ROUNDS); r++) {
                    table += `<tr><td><strong>${r + 1}</strong></td>`;
                    players.forEach(p => {
                        table += `<td>${p.scores[r] !== undefined ? p.scores[r] : '-'}</td>`;
                    });
                    table += '</tr>';
                }

                // Bottom Total Row for convenience
                table += '<tr style="background: var(--input-bg); font-weight: bold;"><td>Tot</td>';
                players.forEach(p => {
                    const total = p.scores.reduce((a, b) => a + b, 0);
                    table += `<td>${total}</td>`;
                });
                table += '</tr></table>';

                container.innerHTML = table;
            }
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function openEditModal() {
            const targetRound = currentRound - 1;
            document.getElementById('editRoundNumber').innerText = targetRound;
            
            const container = document.getElementById('editInputsContainer');
            container.innerHTML = '';

            players.forEach((player, index) => {
                const lastScore = player.scores[targetRound - 1]; 
                const html = `
                <div class="edit-row">
                    <span style="font-weight:bold;">${player.name}</span>
                    <input type="tel" class="round-input" id="edit-input-${index}" value="${lastScore}" style="background:var(--input-bg); border:1px solid var(--subtext);">
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('editModal').classList.remove('hidden');
        }

        function saveEditedRound() {
            const targetRoundIndex = currentRound - 2; 

            for(let i=0; i<players.length; i++) {
                const input = document.getElementById(`edit-input-${i}`);
                if(input.value === '') {
                    input.focus();
                    return;
                }
                players[i].scores[targetRoundIndex] = parseInt(input.value);
            }

            closeModal('editModal');
            renderGame(); 
        }

        function openLeaderboard() {
            const pastGames = JSON.parse(localStorage.getItem('kaboPastGames') || '[]');
            const winCounts = {};

            pastGames.forEach(game => {
                const totals = game.players.map(p => p.scores.reduce((a, b) => a + b, 0));
                const minScore = Math.min(...totals);
                
                game.players.forEach((p, index) => {
                    if (totals[index] === minScore) {
                        winCounts[p.name] = (winCounts[p.name] || 0) + 1;
                    }
                });
            });

            const sortedLeaderboard = Object.entries(winCounts).sort((a, b) => b[1] - a[1]);

            let html = '<table class="history-table"><tr><th>Player</th><th>Wins</th></tr>';
            sortedLeaderboard.forEach(([name, wins]) => {
                html += `<tr><td><span class="clickable-link" onclick="openPlayerWins('${encodeURIComponent(name)}')">${name}</span></td><td>${wins} üëë</td></tr>`;
            });
            html += '</table>';

            document.getElementById('leaderboardContainer').innerHTML = html;
            document.getElementById('leaderboardModal').classList.remove('hidden');
        }

        function openPlayerWins(encodedName) {
            const name = decodeURIComponent(encodedName);
            const pastGames = JSON.parse(localStorage.getItem('kaboPastGames') || '[]');
            let html = '';
            let winCount = 0;

            for (let i = pastGames.length - 1; i >= 0; i--) {
                const game = pastGames[i];
                const totals = game.players.map(p => p.scores.reduce((a, b) => a + b, 0));
                const minScore = Math.min(...totals);
                
                const isWinner = game.players.some((p, index) => p.name === name && totals[index] === minScore);
                
                if (isWinner) {
                    winCount++;
                    html += `
                    <div style="background: var(--input-bg); padding: 12px; border-radius: 12px; margin-bottom: 10px;">
                        <div class="clickable-link" onclick="openPastGameDetails(${i})" style="font-size: 15px;">üìÖ ${game.date}</div>
                        <div style="color: var(--subtext); font-size: 13px; margin-top: 4px;">Winning Score: ${minScore} pts</div>
                    </div>`;
                }
            }

            document.getElementById('playerWinsTitle').innerText = `${name}'s Wins (${winCount})`;
            document.getElementById('playerWinsContainer').innerHTML = html;
            document.getElementById('playerWinsModal').classList.remove('hidden');
        }

        // Simplified Past Game Details - Just shows totals
        function openPastGameDetails(gameIndex) {
            const pastGames = JSON.parse(localStorage.getItem('kaboPastGames') || '[]');
            const game = pastGames[gameIndex];
            
            if (!game) return;

            document.getElementById('pastGameDetailsTitle').innerText = `Game on ${game.date}`;

            let table = '<table class="history-table"><tr><th>Player</th><th>Total Score</th></tr>';

            game.players.forEach(p => {
                const total = p.scores.reduce((a, b) => a + b, 0);
                table += `<tr><td>${p.name}</td><td><strong>${total}</strong></td></tr>`;
            });
            table += '</table>';

            document.getElementById('pastGameDetailsContainer').innerHTML = table;
            document.getElementById('pastGameDetailsModal').classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>
</body>
</html>
